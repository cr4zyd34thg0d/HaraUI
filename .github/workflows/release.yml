name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v2.1.1-alpha)"
        required: true

env:
  CURSEFORGE_PROJECT_ID: "1461250"

jobs:
  release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for creating GitHub Releases

    steps:
      - name: Resolve tag ref
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${GITHUB_REF}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.ref }}
          fetch-depth: 0  # full history so packager can resolve tags

      - name: Parse tag metadata
        id: meta
        run: |
          REF="${{ steps.resolve.outputs.ref }}"
          TAG="${REF#refs/tags/}"
          VERSION="${TAG#v}"

          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-alpha$ ]]; then
            RELEASE_TYPE="alpha"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta$ ]]; then
            RELEASE_TYPE="beta"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            RELEASE_TYPE="release"
          else
            echo "::error::Tag format must be vX.Y.Z, vX.Y.Z-beta, or vX.Y.Z-alpha (example: v2.0.3-alpha)"
            exit 1
          fi

          echo "tag=$TAG"               >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"        >> "$GITHUB_OUTPUT"
          echo "release_type=$RELEASE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Package addon
        uses: BigWigsMods/packager@v2

      - name: Generate release notes from tag range
        id: changelog
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..${TAG}"
            RANGE_LABEL="${PREV_TAG} -> ${TAG}"
          else
            RANGE="${TAG}"
            RANGE_LABEL="start of history -> ${TAG}"
          fi

          BODY="$(RANGE_LABEL="$RANGE_LABEL" git log --no-merges --pretty=format:'%s' "$RANGE" | python3 .github/scripts/release-notes.py)"

          {
            echo "body<<CHANGELOG_EOF"
            echo "$BODY"
            echo "CHANGELOG_EOF"
            echo "range=$RANGE_LABEL"
          } >> "$GITHUB_OUTPUT"

      - name: Find release zip
        id: zip
        run: |
          ZIP=$(ls .release/*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP" ]; then
            echo "::error::No zip found in .release/"
            exit 1
          fi

          # Keep release artifact naming stable across packager output changes.
          VERSION="${{ steps.meta.outputs.version }}"
          CANONICAL=".release/HaraUI-V${VERSION}.zip"
          if [ "$ZIP" != "$CANONICAL" ]; then
            mv "$ZIP" "$CANONICAL"
          fi

          echo "path=$CANONICAL"               >> "$GITHUB_OUTPUT"
          echo "name=$(basename "$CANONICAL")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: HaraUI v${{ steps.meta.outputs.version }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: ${{ steps.meta.outputs.release_type != 'release' }}
          files: ${{ steps.zip.outputs.path }}

      - name: Upload to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: ${{ env.CURSEFORGE_PROJECT_ID }}
          game_endpoint: wow
          file_path: ${{ steps.zip.outputs.path }}
          display_name: HaraUI ${{ steps.meta.outputs.version }}
          release_type: ${{ steps.meta.outputs.release_type }}
          changelog: ${{ steps.changelog.outputs.body }}
          changelog_type: markdown
