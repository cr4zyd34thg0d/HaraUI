name: Release

on:
  push:
    tags:
      - "v*"

env:
  CURSEFORGE_PROJECT_ID: "1461250"

jobs:
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      notes: ${{ steps.changelog.outputs.body }}
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for creating GitHub Releases

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history so packager can resolve tags

      - name: Parse tag metadata
        id: meta
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-alpha$ ]]; then
            RELEASE_TYPE="alpha"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta$ ]]; then
            RELEASE_TYPE="beta"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            RELEASE_TYPE="release"
          else
            echo "::error::Tag format must be vX.Y.Z, vX.Y.Z-beta, or vX.Y.Z-alpha (example: v2.0.3-alpha)"
            exit 1
          fi

          echo "tag=$TAG"               >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"        >> "$GITHUB_OUTPUT"
          echo "release_type=$RELEASE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Package addon
        uses: BigWigsMods/packager@v2

      - name: Generate release notes from tag range
        id: changelog
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..${TAG}"
            RANGE_LABEL="${PREV_TAG} -> ${TAG}"
          else
            RANGE="${TAG}"
            RANGE_LABEL="start of history -> ${TAG}"
          fi

          normalize_subject() {
            local raw="$1"
            local cleaned
            cleaned="$(echo "$raw" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//; s/^[A-Za-z]+(\([^)]+\))?!?:[[:space:]]*//')"
            if [ -z "$cleaned" ]; then
              cleaned="$raw"
            fi
            cleaned="$(echo "$cleaned" | sed -E 's/[[:space:]]+/ /g')"
            local first="${cleaned:0:1}"
            local rest="${cleaned:1}"
            printf '%s%s' "$(echo "$first" | tr '[:lower:]' '[:upper:]')" "$rest"
          }

          added=()
          changed=()
          fixed=()

          while IFS= read -r subject; do
            [ -z "$subject" ] && continue
            lower="$(echo "$subject" | tr '[:upper:]' '[:lower:]')"
            clean="$(normalize_subject "$subject")"
            if [[ "$lower" =~ ^(feat|feature|add|added|new)(\(|:|[[:space:]]) ]]; then
              added+=("$clean")
            elif [[ "$lower" =~ ^(fix|bug|hotfix|patch|regression)(\(|:|[[:space:]]) ]]; then
              fixed+=("$clean")
            else
              changed+=("$clean")
            fi
          done < <(git log --no-merges --pretty=format:'%s' "$RANGE")

          if [ ${#added[@]} -eq 0 ] && [ ${#changed[@]} -eq 0 ] && [ ${#fixed[@]} -eq 0 ]; then
            changed+=("No user-facing changes recorded in this tag range.")
          fi

          BODY="$(
            {
              echo "## Release notes"
              echo
              echo "Range: ${RANGE_LABEL}"
              echo
              if [ ${#added[@]} -gt 0 ]; then
                echo "### Added"
                for item in "${added[@]}"; do
                  echo "- ${item}"
                done
                echo
              fi
              if [ ${#changed[@]} -gt 0 ]; then
                echo "### Changed"
                for item in "${changed[@]}"; do
                  echo "- ${item}"
                done
                echo
              fi
              if [ ${#fixed[@]} -gt 0 ]; then
                echo "### Fixed"
                for item in "${fixed[@]}"; do
                  echo "- ${item}"
                done
              fi
            }
          )"

          {
            echo "body<<CHANGELOG_EOF"
            echo "$BODY"
            echo "CHANGELOG_EOF"
            echo "range=$RANGE_LABEL"
          } >> "$GITHUB_OUTPUT"

      - name: Find release zip
        id: zip
        run: |
          ZIP=$(ls .release/*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP" ]; then
            echo "::error::No zip found in .release/"
            exit 1
          fi

          # Keep release artifact naming stable across packager output changes.
          VERSION="${{ steps.meta.outputs.version }}"
          CANONICAL=".release/HaraUI-V${VERSION}.zip"
          if [ "$ZIP" != "$CANONICAL" ]; then
            mv "$ZIP" "$CANONICAL"
          fi

          echo "path=$CANONICAL"               >> "$GITHUB_OUTPUT"
          echo "name=$(basename "$CANONICAL")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: HaraUI v${{ steps.meta.outputs.version }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: ${{ steps.meta.outputs.release_type != 'release' }}
          files: ${{ steps.zip.outputs.path }}

      - name: Upload to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: ${{ env.CURSEFORGE_PROJECT_ID }}
          game_endpoint: wow
          file_path: ${{ steps.zip.outputs.path }}
          display_name: HaraUI ${{ steps.meta.outputs.version }}
          release_type: ${{ steps.meta.outputs.release_type }}
          changelog: ${{ steps.changelog.outputs.body }}
          changelog_type: markdown

  sync_readme_version:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update README version references
        id: readme
        env:
          RELEASE_TAG: ${{ needs.release.outputs.tag }}
          RELEASE_VERSION: ${{ needs.release.outputs.version }}
          RELEASE_NOTES: ${{ needs.release.outputs.notes }}
        run: |
          TAG="$RELEASE_TAG"
          VERSION="$RELEASE_VERSION"
          BADGE_VERSION="${VERSION//-/--}"
          RELEASE_DATE="$(date -u +%Y-%m-%d)"
          NOTES_BULLETS="$(printf '%s\n' "$RELEASE_NOTES" | awk '/^- / { print }')"

          if [ -z "$NOTES_BULLETS" ]; then
            NOTES_BULLETS="- Updated release metadata."
          fi

          sed -E -i "s#^\!\[HaraUI\]\(https://img\.shields\.io/badge/HaraUI-[^)]*\)#![HaraUI](https://img.shields.io/badge/HaraUI-${BADGE_VERSION}-f97316?style=for-the-badge)#" README.md
          sed -E -i "s#^\| HaraUI \| [^|]+ \|#| HaraUI | ${VERSION} |#" README.md

          ENTRY_FILE="$(mktemp)"
          {
            echo "### ${TAG} - ${RELEASE_DATE}"
            printf '%s\n' "$NOTES_BULLETS"
            echo
          } > "$ENTRY_FILE"

          if ! grep -q "^### ${TAG} - " README.md; then
            awk -v entry_file="$ENTRY_FILE" '
              BEGIN {
                while ((getline line < entry_file) > 0) {
                  entry = entry line "\n"
                }
                close(entry_file)
                inserted = 0
              }
              {
                print
                if (!inserted && $0 ~ /^## :spiral_notepad: Changelog \(Recent\)$/) {
                  print ""
                  printf "%s", entry
                  inserted = 1
                }
              }
            ' README.md > README.md.tmp
            mv README.md.tmp README.md
          fi

          rm -f "$ENTRY_FILE"

          if git diff --quiet -- README.md; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit README update
        if: steps.readme.outputs.changed == 'true'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: bump README version to v${VERSION}"
          git push origin main
