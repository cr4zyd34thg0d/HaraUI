name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v2.1.1-alpha)"
        required: true

env:
  CURSEFORGE_PROJECT_ID: "1461250"

jobs:
  release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for creating GitHub Releases

    steps:
      - name: Resolve tag ref
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${GITHUB_REF}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.ref }}
          fetch-depth: 0  # full history so packager can resolve tags

      - name: Parse tag metadata
        id: meta
        run: |
          REF="${{ steps.resolve.outputs.ref }}"
          TAG="${REF#refs/tags/}"
          VERSION="${TAG#v}"

          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-alpha$ ]]; then
            RELEASE_TYPE="alpha"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta$ ]]; then
            RELEASE_TYPE="beta"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            RELEASE_TYPE="release"
          else
            echo "::error::Tag format must be vX.Y.Z, vX.Y.Z-beta, or vX.Y.Z-alpha (example: v2.0.3-alpha)"
            exit 1
          fi

          echo "tag=$TAG"               >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"        >> "$GITHUB_OUTPUT"
          echo "release_type=$RELEASE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Package addon
        uses: BigWigsMods/packager@v2

      - name: Generate release notes from tag range
        id: changelog
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..${TAG}"
            RANGE_LABEL="${PREV_TAG} -> ${TAG}"
          else
            RANGE="${TAG}"
            RANGE_LABEL="start of history -> ${TAG}"
          fi

          BODY="$(
            RANGE_LABEL="$RANGE_LABEL" git log --no-merges --pretty=format:'%s' "$RANGE" | python3 - <<'PY'
import os
import re
import sys
from collections import OrderedDict


def normalize_subject(raw: str) -> str:
    cleaned = raw.strip()
    cleaned = re.sub(r"^[A-Za-z]+(\([^)]+\))?!?:\s*", "", cleaned)
    if not cleaned:
        cleaned = raw.strip()
    cleaned = re.sub(r"\s+", " ", cleaned)
    if cleaned:
        cleaned = cleaned[0].upper() + cleaned[1:]
    return cleaned


def classify(lower_subject: str) -> str:
    if any(k in lower_subject for k in ("readme", "docs", "changelog", "agents.md")):
        return "Documentation"
    if any(k in lower_subject for k in ("ci:", "release", "tag", "artifact", "packager", "curseforge", "workflow")):
        return "Release Pipeline"
    if any(k in lower_subject for k in ("currency", "transfer", "taint", "tokenui")):
        return "Currency Transfer"
    if any(k in lower_subject for k in ("friendly", "nameplate", "platynator")):
        return "Friendly Nameplates"
    if any(k in lower_subject for k in ("rotation helper", "rotation")):
        return "Rotation Helper"
    if any(k in lower_subject for k in ("xp", "cast", "loot", "summon", "minimap", "tracked bars", "game menu", "tooltip")):
        return "Core UI Modules"
    if any(
        k in lower_subject
        for k in (
            "charsheet",
            "character sheet",
            "mythic",
            "vault",
            "gear cluster",
            "stat cluster",
            "equipment",
            "title row",
            "title click",
            "pane",
            "portal",
            "spec highlight",
            "layout",
        )
    ):
        return "Character Sheet"
    return "Maintenance"


order = [
    "Character Sheet",
    "Currency Transfer",
    "Friendly Nameplates",
    "Rotation Helper",
    "Core UI Modules",
    "Documentation",
    "Release Pipeline",
    "Maintenance",
]

summaries = {
    "Character Sheet": "Refined Character Sheet layout, panel presentation, and interaction polish for smoother day-to-day navigation.",
    "Currency Transfer": "Hardened account-currency transfer behavior to reduce taint risk and keep native Character/Reputation/Currency flows stable.",
    "Friendly Nameplates": "Improved friendly nameplate reliability and option sync behavior in combat and restricted UI states.",
    "Rotation Helper": "Adjusted Rotation Helper behavior and layering so it stays visible when useful without obstructing core UI.",
    "Core UI Modules": "Polished core module behavior across XP/Cast/Loot/Minimap/Game Menu and related utility controls.",
    "Documentation": "Updated player-facing documentation to match the current addon scope, setup path, and feature list.",
    "Release Pipeline": "Improved release automation and publishing consistency across tags, artifacts, and store metadata.",
    "Maintenance": "Applied internal refactors and cleanup work to keep systems stable and easier to evolve.",
}

buckets = OrderedDict((key, []) for key in order)
subjects = [line.strip() for line in sys.stdin if line.strip()]
for subject in subjects:
    clean = normalize_subject(subject)
    feature = classify(subject.lower())
    buckets[feature].append(clean)

lines = ["## Release notes", "", f"Range: {os.environ.get('RANGE_LABEL', 'unknown')}", ""]

if not subjects:
    lines.append("### Feature: Maintenance")
    lines.append("- No user-facing changes recorded in this tag range.")
else:
    for feature in order:
        count = len(buckets[feature])
        if count == 0:
            continue
        noun = "commit" if count == 1 else "commits"
        lines.append(f"### Feature: {feature}")
        lines.append(f"- {summaries[feature]} ({count} {noun} in this release range.)")
        lines.append("")

print("\n".join(lines).rstrip())
PY
          )"

          {
            echo "body<<CHANGELOG_EOF"
            echo "$BODY"
            echo "CHANGELOG_EOF"
            echo "range=$RANGE_LABEL"
          } >> "$GITHUB_OUTPUT"

      - name: Find release zip
        id: zip
        run: |
          ZIP=$(ls .release/*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP" ]; then
            echo "::error::No zip found in .release/"
            exit 1
          fi

          # Keep release artifact naming stable across packager output changes.
          VERSION="${{ steps.meta.outputs.version }}"
          CANONICAL=".release/HaraUI-V${VERSION}.zip"
          if [ "$ZIP" != "$CANONICAL" ]; then
            mv "$ZIP" "$CANONICAL"
          fi

          echo "path=$CANONICAL"               >> "$GITHUB_OUTPUT"
          echo "name=$(basename "$CANONICAL")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: HaraUI v${{ steps.meta.outputs.version }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: ${{ steps.meta.outputs.release_type != 'release' }}
          files: ${{ steps.zip.outputs.path }}

      - name: Upload to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: ${{ env.CURSEFORGE_PROJECT_ID }}
          game_endpoint: wow
          file_path: ${{ steps.zip.outputs.path }}
          display_name: HaraUI ${{ steps.meta.outputs.version }}
          release_type: ${{ steps.meta.outputs.release_type }}
          changelog: ${{ steps.changelog.outputs.body }}
          changelog_type: markdown

  sync_readme_version:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update README version references
        id: readme
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          BADGE_VERSION="${VERSION//-/--}"

          sed -E -i "s#^\!\[HaraUI\]\(https://img\.shields\.io/badge/HaraUI-[^)]*\)#![HaraUI](https://img.shields.io/badge/HaraUI-${BADGE_VERSION}-f97316?style=for-the-badge)#" README.md
          sed -E -i "s#^- \*\*Bundle Release:\*\* \`v[^`]+\` \(rolling main\)#- **Bundle Release:** \`v${VERSION}\` (rolling main)#" README.md
          sed -E -i "s#^\| HaraUI \| [^|]+ \|#| HaraUI | ${VERSION} |#" README.md

          if git diff --quiet -- README.md; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit README update
        if: steps.readme.outputs.changed == 'true'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: bump README version to v${VERSION}"
          git push origin main
