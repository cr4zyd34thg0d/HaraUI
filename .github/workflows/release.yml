name: Release

on:
  push:
    tags:
      - "v*"

env:
  CURSEFORGE_PROJECT_ID: "1461250"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for creating GitHub Releases

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history so packager can resolve tags

      - name: Parse tag metadata
        id: meta
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          if [[ "$TAG" == *-alpha* ]]; then
            RELEASE_TYPE="alpha"
          elif [[ "$TAG" == *-beta* ]]; then
            RELEASE_TYPE="beta"
          else
            RELEASE_TYPE="release"
          fi

          echo "tag=$TAG"               >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"        >> "$GITHUB_OUTPUT"
          echo "release_type=$RELEASE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Package addon
        uses: BigWigsMods/packager@v2

      - name: Generate changelog
        id: changelog
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Find the previous tag (skip current)
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${TAG}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            # First tag ever â€” use all commits
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          {
            echo "body<<CHANGELOG_EOF"
            echo "## What's Changed"
            echo ""
            git log "$RANGE" --pretty=format:"- %s" --no-merges \
              | grep -v "Co-Authored-By" \
              | grep -v "^$"
            echo ""
            echo ""
            echo "**Full diff**: https://github.com/${{ github.repository }}/compare/${PREV_TAG:-HEAD~10}...${TAG}"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Find release zip
        id: zip
        run: |
          ZIP=$(ls .release/*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP" ]; then
            echo "::error::No zip found in .release/"
            exit 1
          fi
          echo "path=$ZIP"               >> "$GITHUB_OUTPUT"
          echo "name=$(basename "$ZIP")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: HaraUI ${{ steps.meta.outputs.tag }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: ${{ steps.meta.outputs.release_type != 'release' }}
          files: ${{ steps.zip.outputs.path }}

      - name: Upload to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: ${{ env.CURSEFORGE_PROJECT_ID }}
          game_endpoint: wow
          file_path: ${{ steps.zip.outputs.path }}
          display_name: HaraUI ${{ steps.meta.outputs.version }}
          release_type: ${{ steps.meta.outputs.release_type }}
          changelog: ${{ steps.changelog.outputs.body }}
          changelog_type: markdown
