name: Release

on:
  push:
    tags:
      - "v*"

env:
  CURSEFORGE_PROJECT_ID: "1461250"

jobs:
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for creating GitHub Releases

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history so packager can resolve tags

      - name: Parse tag metadata
        id: meta
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          if [[ "$TAG" == *-alpha* ]]; then
            RELEASE_TYPE="alpha"
          elif [[ "$TAG" == *-beta* ]]; then
            RELEASE_TYPE="beta"
          else
            RELEASE_TYPE="release"
          fi

          echo "tag=$TAG"               >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"        >> "$GITHUB_OUTPUT"
          echo "release_type=$RELEASE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Package addon
        uses: BigWigsMods/packager@v2

      - name: Generate release notes from tag range
        id: changelog
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..${TAG}"
            RANGE_LABEL="${PREV_TAG} -> ${TAG}"
          else
            RANGE="${TAG}"
            RANGE_LABEL="start of history -> ${TAG}"
          fi

          normalize_subject() {
            local raw="$1"
            local cleaned
            cleaned="$(echo "$raw" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//; s/^[A-Za-z]+(\([^)]+\))?!?:[[:space:]]*//')"
            if [ -z "$cleaned" ]; then
              cleaned="$raw"
            fi
            cleaned="$(echo "$cleaned" | sed -E 's/[[:space:]]+/ /g')"
            local first="${cleaned:0:1}"
            local rest="${cleaned:1}"
            printf '%s%s' "$(echo "$first" | tr '[:lower:]' '[:upper:]')" "$rest"
          }

          added=()
          changed=()
          fixed=()

          while IFS= read -r subject; do
            [ -z "$subject" ] && continue
            lower="$(echo "$subject" | tr '[:upper:]' '[:lower:]')"
            clean="$(normalize_subject "$subject")"
            if [[ "$lower" =~ ^(feat|feature|add|added|new)(\(|:|[[:space:]]) ]]; then
              added+=("$clean")
            elif [[ "$lower" =~ ^(fix|bug|hotfix|patch|regression)(\(|:|[[:space:]]) ]]; then
              fixed+=("$clean")
            else
              changed+=("$clean")
            fi
          done < <(git log --no-merges --pretty=format:'%s' "$RANGE")

          if [ ${#added[@]} -eq 0 ] && [ ${#changed[@]} -eq 0 ] && [ ${#fixed[@]} -eq 0 ]; then
            changed+=("No user-facing changes recorded in this tag range.")
          fi

          BODY="$(
            {
              echo "## Release notes"
              echo
              echo "Range: ${RANGE_LABEL}"
              echo
              if [ ${#added[@]} -gt 0 ]; then
                echo "### Added"
                for item in "${added[@]}"; do
                  echo "- ${item}"
                done
                echo
              fi
              if [ ${#changed[@]} -gt 0 ]; then
                echo "### Changed"
                for item in "${changed[@]}"; do
                  echo "- ${item}"
                done
                echo
              fi
              if [ ${#fixed[@]} -gt 0 ]; then
                echo "### Fixed"
                for item in "${fixed[@]}"; do
                  echo "- ${item}"
                done
              fi
            }
          )"

          {
            echo "body<<CHANGELOG_EOF"
            echo "$BODY"
            echo "CHANGELOG_EOF"
            echo "range=$RANGE_LABEL"
          } >> "$GITHUB_OUTPUT"

      - name: Find release zip
        id: zip
        run: |
          ZIP=$(ls .release/*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP" ]; then
            echo "::error::No zip found in .release/"
            exit 1
          fi
          echo "path=$ZIP"               >> "$GITHUB_OUTPUT"
          echo "name=$(basename "$ZIP")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: HaraUI ${{ steps.meta.outputs.tag }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: ${{ steps.meta.outputs.release_type != 'release' }}
          files: ${{ steps.zip.outputs.path }}

      - name: Upload to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: ${{ env.CURSEFORGE_PROJECT_ID }}
          game_endpoint: wow
          file_path: ${{ steps.zip.outputs.path }}
          display_name: HaraUI ${{ steps.meta.outputs.version }}
          release_type: ${{ steps.meta.outputs.release_type }}
          changelog: ${{ steps.changelog.outputs.body }}
          changelog_type: markdown
